"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[2160],{3905:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>m});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=a.createContext({}),p=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},u=function(e){var n=p(e.components);return a.createElement(s.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=p(t),m=r,f=d["".concat(s,".").concat(m)]||d[m]||c[m]||i;return t?a.createElement(f,o(o({ref:n},u),{},{components:t})):a.createElement(f,o({ref:n},u))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,o=new Array(i);o[0]=d;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var p=2;p<i;p++)o[p]=t[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},7325:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>l,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>u});var a=t(7462),r=(t(7294),t(3905)),i=t(941);const o={title:"NGINX and App Daemon"},l=void 0,s={unversionedId:"features/nginx",id:"features/nginx",title:"NGINX and App Daemon",description:"Our server serves HTTP and HTTPS traffic using NGINX. NGINX is used to serve static files and proxy requests to the app daemon. Because it operates for all users on the server, only a limited set of features are configurable. It's only configurable using the runner.",source:"@site/docs/features/nginx.md",sourceDirName:"features",slug:"/features/nginx",permalink:"/docs/features/nginx",draft:!1,editUrl:"https://github.com/domcloud/domcloud-co/tree/master/docs/features/nginx.md",tags:[],version:"current",frontMatter:{title:"NGINX and App Daemon"},sidebar:"tutorialSidebar",previous:{title:"Firewall Daemon",permalink:"/docs/features/firewall"},next:{title:"The System Runner",permalink:"/docs/features/runner"}},p={},u=[{value:"Check current configuration",id:"check-current-configuration",level:2},{value:"Configure NGINX for HTTPS",id:"configure-nginx-for-https",level:2},{value:"Configure NGINX for PHP",id:"configure-nginx-for-php",level:2},{value:"Configure NGINX for General Apps",id:"configure-nginx-for-general-apps",level:2},{value:"PORT environment variable",id:"port-environment-variable",level:3},{value:"Set Environment Variables",id:"set-environment-variables",level:3},{value:"<code>app_env</code> option",id:"app_env-option",level:3},{value:"<code>env_var_list</code> option",id:"env_var_list-option",level:3},{value:"<code>~/.bashrc</code> file",id:"bashrc-file",level:3},{value:"Restarting App",id:"restarting-app",level:3},{value:"Websocket",id:"websocket",level:3},{value:"Language-Specific Configuration",id:"language-specific-configuration",level:2},{value:"Global Configuration",id:"global-configuration",level:2}],c={toc:u};function d(e){let{components:n,...t}=e;return(0,r.kt)("wrapper",(0,a.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Our server serves HTTP and HTTPS traffic using NGINX. NGINX is used to serve static files and proxy requests to the app daemon. Because it operates for all users on the server, only a limited set of features are configurable. It's only configurable using the ",(0,r.kt)("a",{parentName:"p",href:"/docs/features/runner#nginx"},"runner"),"."),(0,r.kt)("p",null,"If you don't familiar with NGINX, you can read some of good resorces here: "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://nginx.org/en/docs/"},"Official documentation")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://www.freecodecamp.org/news/the-nginx-handbook/"},"The NGINX Handbook"))),(0,r.kt)("h2",{id:"check-current-configuration"},"Check current configuration"),(0,r.kt)("p",null,"You can check the current configuration by going to Check -> NGINX."),(0,r.kt)(i.Z,{sources:{dark:"/assets/ss/check-nginx-b.png",light:"/assets/ss/check-nginx-w.png"},alt:"",className:"img-fluid border rounded-3 shadow--md mb-4",width:"700",height:"500",loading:"lazy",mdxType:"ThemedImage"}),(0,r.kt)("p",null,"The left side is the configurable options, and the right side is the current configuration applied in NGINX. The configurable option is written in YAML format, which when saved, applied as a new configuration configured via ",(0,r.kt)("a",{parentName:"p",href:"/docs/features/runner#nginx"},"the runner"),"."),(0,r.kt)("p",null,"Below is the example of the configuration:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"nginx:\n  fastcgi: 'on'\n  root: public_html\n  index: index.html index.php\n  ssl: 'on'\n")),(0,r.kt)("h2",{id:"configure-nginx-for-https"},"Configure NGINX for HTTPS"),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"/docs/features/runner#ssl-1"},(0,r.kt)("inlineCode",{parentName:"a"},"ssl"))," option has three options: ",(0,r.kt)("inlineCode",{parentName:"p"},"always"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"on"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"off"),". The ",(0,r.kt)("inlineCode",{parentName:"p"},"always")," option will force the server to redirect all HTTP traffic to HTTPS. The default value for ",(0,r.kt)("inlineCode",{parentName:"p"},"ssl")," is ",(0,r.kt)("inlineCode",{parentName:"p"},"on"),"."),(0,r.kt)("h2",{id:"configure-nginx-for-php"},"Configure NGINX for PHP"),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"/docs/features/runner#fastcgi"},(0,r.kt)("inlineCode",{parentName:"a"},"fastcgi"))," option has three options: ",(0,r.kt)("inlineCode",{parentName:"p"},"always"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"on"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"off"),". The default value for ",(0,r.kt)("inlineCode",{parentName:"p"},"fastcgi")," is ",(0,r.kt)("inlineCode",{parentName:"p"},"off"),"."),(0,r.kt)("p",null,"This section is covered more in the ",(0,r.kt)("a",{parentName:"p",href:"/docs/deployment/php#nginx-setup"},"PHP Deployment")," section."),(0,r.kt)("h2",{id:"configure-nginx-for-general-apps"},"Configure NGINX for General Apps"),(0,r.kt)("p",null,"NGINX by default only forwards connection and can't invoke the desired app to run. We use ",(0,r.kt)("a",{parentName:"p",href:"https://www.phusionpassenger.com/"},"Phusion Passenger")," so we can configure NGINX to invoke the app and forwards HTTP requests."),(0,r.kt)("p",null,"The minimum configuration to enable NGINX for general apps is:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"nginx:\n  root: public_html/public\n  passenger:\n    enabled: on\n    app_start_command: env PORT=$PORT npm start\n")),(0,r.kt)("p",null,"Which is equivalent to running ",(0,r.kt)("inlineCode",{parentName:"p"},"npm start")," in the ",(0,r.kt)("inlineCode",{parentName:"p"},"public_html")," (parent of root) directory, with the ",(0,r.kt)("inlineCode",{parentName:"p"},"PORT")," environment variable set to the port that NGINX is listening to."),(0,r.kt)("p",null,"Passenger's ",(0,r.kt)("inlineCode",{parentName:"p"},"enabled: on")," config is required to indicate that Passenger's module is activated for given host."),(0,r.kt)("p",null,"It is important that  ",(0,r.kt)("inlineCode",{parentName:"p"},"root")," is set to the directory that contains the ",(0,r.kt)("inlineCode",{parentName:"p"},"public")," directory. This is because NGINX will serve the ",(0,r.kt)("inlineCode",{parentName:"p"},"public")," directory as the root directory for serving static files, and you don't want to expose the entire app directory to the public."),(0,r.kt)("p",null,"If the app must be called from a subdirectory, you can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"app_root")," option to specify the directory that contains the app. For example, if the main app file is in ",(0,r.kt)("inlineCode",{parentName:"p"},"public_html/server/app.js"),", you can set the ",(0,r.kt)("inlineCode",{parentName:"p"},"app_root")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"public_html/server"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"nginx:\n  root: public_html/public\n  passenger:\n    enabled: on\n    app_root: public_html/server\n    app_start_command: env PORT=$PORT node app.js\n")),(0,r.kt)("h3",{id:"port-environment-variable"},"PORT environment variable"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"$PORT")," environment variable is set by NGINX. It is a random port that's chosen to be proxied from NGINX. The app must listen to this port to receive HTTP requests."),(0,r.kt)("p",null,"You can tell the app to listen to this port by setting the an environment variable via ",(0,r.kt)("inlineCode",{parentName:"p"},"env")," like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"app_start_command: env PORT=$PORT node app.js\n")),(0,r.kt)("p",null,"Or you can set the port using the app's argument if available:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"app_start_command: node app.js --port $PORT\n")),(0,r.kt)("h3",{id:"set-environment-variables"},"Set Environment Variables"),(0,r.kt)("p",null,"Passenger has three ways to set environment variables:"),(0,r.kt)("h3",{id:"app_env-option"},(0,r.kt)("inlineCode",{parentName:"h3"},"app_env")," option"),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"./runner#passenger"},(0,r.kt)("inlineCode",{parentName:"a"},"app_env"))," option is special option that's used to set environment mode. The default value is ",(0,r.kt)("inlineCode",{parentName:"p"},"production"),". This option sets the value to the following environment variables:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"RAILS_ENV")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"RACK_ENV")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"WSGI_ENV")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"NODE_ENV")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"PASSENGER_APP_ENV"))),(0,r.kt)("p",null,"You can set this value other values such as ",(0,r.kt)("inlineCode",{parentName:"p"},"development")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"test"),"."),(0,r.kt)("h3",{id:"env_var_list-option"},(0,r.kt)("inlineCode",{parentName:"h3"},"env_var_list")," option"),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"./runner#passenger"},(0,r.kt)("inlineCode",{parentName:"a"},"env_var_list"))," option is used to set environment variables directly from NGINX. It's a list of environment variables to set. The value is a string that's in the format of ",(0,r.kt)("inlineCode",{parentName:"p"},"KEY=VALUE"),". For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'nginx:\n  passenger:\n    enabled: on\n    app_start_command: env PORT=$PORT node app.js\n    env_var_list:\n      - APP_SECRET=SECRET_VALUE\n      - APP_CONFIG={"key":"value"}\n')),(0,r.kt)("h3",{id:"bashrc-file"},(0,r.kt)("inlineCode",{parentName:"h3"},"~/.bashrc")," file"),(0,r.kt)("p",null,"Passenger reads the ",(0,r.kt)("inlineCode",{parentName:"p"},"~/.bashrc")," file to set environment variables. You can set environment variables in this way. For example run this command to edit the ",(0,r.kt)("inlineCode",{parentName:"p"},"~/.bashrc")," file via SSH:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"nano ~/.bashrc\n")),(0,r.kt)("p",null,"Then add the following line to the file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"export APP_SECRET=SECRET_VALUE\n")),(0,r.kt)("p",null,"The environment variable will be set when the app is started next time. "),(0,r.kt)("p",null,"More information about setting environment variables can be found in the ",(0,r.kt)("a",{parentName:"p",href:"https://www.phusionpassenger.com/docs/advanced_guides/in_depth/node/environment_variables.html"},"Passenger documentation"),"."),(0,r.kt)("h3",{id:"restarting-app"},"Restarting App"),(0,r.kt)("p",null,"Any edits either in the app file or ",(0,r.kt)("inlineCode",{parentName:"p"},"~/.bashrc")," file will not be applied until the app is restarted. You can restart the app forcibly by running this in SSH:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"passenger-config restart-app /\n")),(0,r.kt)("p",null,"More information about restarting app can be found in the ",(0,r.kt)("a",{parentName:"p",href:"https://www.phusionpassenger.com/docs/tutorials/reloading_code/node/"},"Passenger documentation"),"."),(0,r.kt)("h3",{id:"websocket"},"Websocket"),(0,r.kt)("p",null,"If the app uses Websocket, you have to enable sticky sessions in NGINX. This is because there will be multiple process spawned and Phusion Passenger will load balance the requests to the processes. If the requests are not sticky, the Websocket connection will be lost."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"sticky_sessions: on\n")),(0,r.kt)("p",null,"You can read more about websocket usage at the ",(0,r.kt)("a",{parentName:"p",href:"https://www.phusionpassenger.com/docs/references/config_reference/nginx/#passenger_sticky_sessions"},"Passenger documentation")),(0,r.kt)("h2",{id:"language-specific-configuration"},"Language-Specific Configuration"),(0,r.kt)("p",null,"More information about configuring NGINX for specific languages can be found in the ",(0,r.kt)("a",{parentName:"p",href:"../deployment"},"Deployment")," section."),(0,r.kt)("h2",{id:"global-configuration"},"Global Configuration"),(0,r.kt)("p",null,"Global configuration of NGINX cannot be changed. However, some of the configuration are set as optimally as possible. You can see more about the global configuration in ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/domcloud/container/blob/master/templates/nginx.conf"},"this file"),". Some of the interesting configuration are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Static files are cached with ",(0,r.kt)("inlineCode",{parentName:"li"},"max")," expiration time."),(0,r.kt)("li",{parentName:"ul"},"Gzip are enabled for ",(0,r.kt)("inlineCode",{parentName:"li"},"css"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"js"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"svg")," static files."),(0,r.kt)("li",{parentName:"ul"},"Maximum file upload size is set to 512MB."),(0,r.kt)("li",{parentName:"ul"},"There's ",(0,r.kt)("a",{parentName:"li",href:"https://www.nginx.com/blog/rate-limiting-nginx/"},"rate limit")," of 4 requests per second with 100 burst request per IP address to mitigate DoS attack.")))}d.isMDXComponent=!0}}]);