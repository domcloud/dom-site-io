"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[5398],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var p=a.createContext({}),s=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=s(e.components);return a.createElement(p.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,l=e.originalType,p=e.parentName,u=r(e,["components","mdxType","originalType","parentName"]),c=s(n),m=i,h=c["".concat(p,".").concat(m)]||c[m]||d[m]||l;return n?a.createElement(h,o(o({ref:t},u),{},{components:n})):a.createElement(h,o({ref:t},u))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var l=n.length,o=new Array(l);o[0]=c;var r={};for(var p in t)hasOwnProperty.call(t,p)&&(r[p]=t[p]);r.originalType=e,r.mdxType="string"==typeof e?e:i,o[1]=r;for(var s=2;s<l;s++)o[s]=n[s];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},5162:(e,t,n)=>{n.d(t,{Z:()=>o});var a=n(7294),i=n(6010);const l="tabItem_Ymn6";function o(e){let{children:t,hidden:n,className:o}=e;return a.createElement("div",{role:"tabpanel",className:(0,i.Z)(l,o),hidden:n},t)}},4866:(e,t,n)=>{n.d(t,{Z:()=>P});var a=n(7462),i=n(7294),l=n(6010),o=n(2466),r=n(6775),p=n(1980),s=n(7392),u=n(12);function d(e){return function(e){var t;return(null==(t=i.Children.map(e,(e=>{if(!e||(0,i.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})))?void 0:t.filter(Boolean))??[]}(e).map((e=>{let{props:{value:t,label:n,attributes:a,default:i}}=e;return{value:t,label:n,attributes:a,default:i}}))}function c(e){const{values:t,children:n}=e;return(0,i.useMemo)((()=>{const e=t??d(n);return function(e){const t=(0,s.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function m(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function h(e){let{queryString:t=!1,groupId:n}=e;const a=(0,r.k6)(),l=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,p._X)(l),(0,i.useCallback)((e=>{if(!l)return;const t=new URLSearchParams(a.location.search);t.set(l,e),a.replace({...a.location,search:t.toString()})}),[l,a])]}function g(e){const{defaultValue:t,queryString:n=!1,groupId:a}=e,l=c(e),[o,r]=(0,i.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!m({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const a=n.find((e=>e.default))??n[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:t,tabValues:l}))),[p,s]=h({queryString:n,groupId:a}),[d,g]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[a,l]=(0,u.Nk)(n);return[a,(0,i.useCallback)((e=>{n&&l.set(e)}),[n,l])]}({groupId:a}),f=(()=>{const e=p??d;return m({value:e,tabValues:l})?e:null})();(0,i.useLayoutEffect)((()=>{f&&r(f)}),[f]);return{selectedValue:o,selectValue:(0,i.useCallback)((e=>{if(!m({value:e,tabValues:l}))throw new Error(`Can't select invalid tab value=${e}`);r(e),s(e),g(e)}),[s,g,l]),tabValues:l}}var f=n(2389);const k="tabList__CuJ",v="tabItem_LNqP";function b(e){let{className:t,block:n,selectedValue:r,selectValue:p,tabValues:s}=e;const u=[],{blockElementScrollPositionUntilNextRender:d}=(0,o.o5)(),c=e=>{const t=e.currentTarget,n=u.indexOf(t),a=s[n].value;a!==r&&(d(t),p(a))},m=e=>{var t;let n=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const t=u.indexOf(e.currentTarget)+1;n=u[t]??u[0];break}case"ArrowLeft":{const t=u.indexOf(e.currentTarget)-1;n=u[t]??u[u.length-1];break}}null==(t=n)||t.focus()};return i.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,l.Z)("tabs",{"tabs--block":n},t)},s.map((e=>{let{value:t,label:n,attributes:o}=e;return i.createElement("li",(0,a.Z)({role:"tab",tabIndex:r===t?0:-1,"aria-selected":r===t,key:t,ref:e=>u.push(e),onKeyDown:m,onClick:c},o,{className:(0,l.Z)("tabs__item",v,null==o?void 0:o.className,{"tabs__item--active":r===t})}),n??t)})))}function N(e){let{lazy:t,children:n,selectedValue:a}=e;const l=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=l.find((e=>e.props.value===a));return e?(0,i.cloneElement)(e,{className:"margin-top--md"}):null}return i.createElement("div",{className:"margin-top--md"},l.map(((e,t)=>(0,i.cloneElement)(e,{key:t,hidden:e.props.value!==a}))))}function y(e){const t=g(e);return i.createElement("div",{className:(0,l.Z)("tabs-container",k)},i.createElement(b,(0,a.Z)({},e,t)),i.createElement(N,(0,a.Z)({},e,t)))}function P(e){const t=(0,f.Z)();return i.createElement(y,(0,a.Z)({key:String(t)},e))}},2626:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>p,default:()=>m,frontMatter:()=>r,metadata:()=>s,toc:()=>d});var a=n(7462),i=(n(7294),n(3905)),l=n(4866),o=n(5162);const r={title:"PHP",sidebar_position:2},p="Deploy PHP Apps",s={unversionedId:"deployment/php",id:"deployment/php",title:"PHP",description:"PHP is a popular programming language for web development. PHP is served in production server using PHP-FPM.",source:"@site/docs/deployment/php.md",sourceDirName:"deployment",slug:"/deployment/php",permalink:"/docs/deployment/php",draft:!1,editUrl:"https://github.com/domcloud/domcloud-co/tree/master/docs/deployment/php.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{title:"PHP",sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Static Sites",permalink:"/docs/deployment/static-site"},next:{title:"Node.js",permalink:"/docs/deployment/node"}},u={},d=[{value:"Recipes",id:"recipes",level:2},{value:"Development Mode",id:"development-mode",level:3},{value:"Init in Development Mode",id:"init-in-development-mode",level:3},{value:"Switch to Production Mode",id:"switch-to-production-mode",level:3},{value:"Init in Development Mode",id:"init-in-development-mode-1",level:3},{value:"Enable Laravel UI",id:"enable-laravel-ui",level:3},{value:"Switch to Production Mode",id:"switch-to-production-mode-1",level:3},{value:"NGINX Setup",id:"nginx-setup",level:2},{value:"<code>fastcgi</code> Options",id:"fastcgi-options",level:3},{value:"<code>fastcgi</code> Options <code>off</code>",id:"fastcgi-options-off",level:4},{value:"<code>fastcgi</code> Options <code>on</code>",id:"fastcgi-options-on",level:4},{value:"<code>fastcgi</code> Options <code>always</code>",id:"fastcgi-options-always",level:4},{value:"Multiple Directory Setup",id:"multiple-directory-setup",level:3},{value:"Rewrite root directory",id:"rewrite-root-directory",level:3},{value:"Reroute index.php",id:"reroute-indexphp",level:3},{value:"Multiple website in a domain",id:"multiple-website-in-a-domain",level:3},{value:"PHP environment setup",id:"php-environment-setup",level:2},{value:"Composer install",id:"composer-install",level:2},{value:"Clearing composer cache",id:"clearing-composer-cache",level:3},{value:"PHP INI configuration",id:"php-ini-configuration",level:2},{value:"PHP Error Logging",id:"php-error-logging",level:2},{value:"Restarting PHP",id:"restarting-php",level:2}],c={toc:d};function m(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"deploy-php-apps"},"Deploy PHP Apps"),(0,i.kt)("p",null,"PHP is a popular programming language for web development. PHP is served in production server using PHP-FPM."),(0,i.kt)("p",null,"Popular PHP recipes is ",(0,i.kt)("a",{parentName:"p",href:"https://codeigniter.com/"},"CodeIgniter")," and ",(0,i.kt)("a",{parentName:"p",href:"https://laravel.com/"},"Laravel"),". Please read our ",(0,i.kt)("a",{parentName:"p",href:"/docs/features/runner"},"Runner's Guide")," first if you haven't."),(0,i.kt)("h2",{id:"recipes"},"Recipes"),(0,i.kt)(l.Z,{mdxType:"Tabs"},(0,i.kt)(o.Z,{value:"simple",label:"General PHP",default:!0,mdxType:"TabItem"},(0,i.kt)("h3",{id:"development-mode"},"Development Mode"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'source: clear\nnginx:\n  fastcgi: on\ncommands:\n- echo "<h1>Hello, World!</h1>" > index.php\n- echo "<?php phpinfo(15);" > phpinfo.php\n- echo "display_errors = On" > .user.ini\n- echo "display_startup_errors = On" >> .user.ini\n')),(0,i.kt)("p",null,'This creates a simple PHP that outputs "Hello, World!" and load some useful development features.')),(0,i.kt)(o.Z,{value:"codeigniter",label:"CodeIgniter",mdxType:"TabItem"},(0,i.kt)("h3",{id:"init-in-development-mode"},"Init in Development Mode"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'source: clear\nfeatures:\n- mysql\nroot: public_html/public\nnginx:\n  fastcgi: on\n  locations:\n  - match: /\n    try_files: $uri $uri/ /index.php$is_args$args\ncommands:\n- composer create-project codeigniter4/appstarter .\n- cp env .env\n- sed -ri "s/.*database.default.database.*/database.default.database = ${DATABASE}/g" .env\n- sed -ri "s/.*database.default.username.*/database.default.username = ${USERNAME}/g" .env\n- sed -ri "s/.*database.default.password.*/database.default.password = ${PASSWORD}/g" .env\n- sed -ri "s/.*app.baseURL.*/app.baseURL = https:\\/\\/${DOMAIN}/g" .env\n- composer install\n')),(0,i.kt)("p",null,"This set up a fresh CodeIgniter project in development mode with a database initialized."),(0,i.kt)("h3",{id:"switch-to-production-mode"},"Switch to Production Mode"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"commands:\n- 'sed -ri \"s/# CI_ENVIRONMENT = production/CI_ENVIRONMENT = production/g\" .env'\n- composer install --no-dev --optimize-autoloader\n")),(0,i.kt)("p",null,"This sets up CodeIgniter in production mode.")),(0,i.kt)(o.Z,{value:"laravel",label:"Laravel",mdxType:"TabItem"},(0,i.kt)("h3",{id:"init-in-development-mode-1"},"Init in Development Mode"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'source: clear\nroot: public_html/public\nfeatures:\n- php latest\n- mysql\nnginx:\n  fastcgi: on\n  locations:\n  - match: /\n    try_files: $uri $uri/ /index.php$is_args$args\ncommands:\n- composer create-project laravel/laravel .\n- mv .env.example .env\n- sed -i "s/DB_HOST=127.0.0.1/DB_HOST=localhost/g" .env\n- sed -ri "s/DB_DATABASE=.*/DB_DATABASE=${DATABASE}/g" .env\n- sed -ri "s/DB_USERNAME=.*/DB_USERNAME=${USERNAME}/g" .env\n- sed -ri "s/DB_PASSWORD=.*/DB_PASSWORD=${PASSWORD}/g" .env\n- sed -ri "s/APP_URL=.*/APP_URL=http:\\/\\/${DOMAIN}/g" .env\n- composer install\n- php artisan migrate:fresh\n- php artisan key:generate\n- php artisan storage:link\n')),(0,i.kt)("p",null,"This set up a fresh Laravel project in development mode with a database initialized."),(0,i.kt)("h3",{id:"enable-laravel-ui"},"Enable Laravel UI"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"commands:\n- composer require laravel/ui\n- php artisan ui bootstrap \u2013-auth\n- npm install\n- npm run build\n")),(0,i.kt)("p",null,"This enables Laravel UI with Bootstrap and authentication."),(0,i.kt)("admonition",{type:"info"},(0,i.kt)("p",{parentName:"admonition"},"If you wish to enable development mode with Laravel UI, specify the host IP address and random ephemeral ports. Run this in CLI/SSH:"),(0,i.kt)("pre",{parentName:"admonition"},(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'npm run dev -- --host `hostname -I | cut -d " " -f1` --port `shuf -n 1 -i 49152-65535`\n')),(0,i.kt)("p",{parentName:"admonition"},"Note: this doesn't work with HTTPS, only run it in development mode. You might need to set the ",(0,i.kt)("inlineCode",{parentName:"p"},"APP_URL")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"http://...")," in ",(0,i.kt)("inlineCode",{parentName:"p"},".env"),".")),(0,i.kt)("h3",{id:"switch-to-production-mode-1"},"Switch to Production Mode"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'features:\n- ssl\ncommands:\n- sed -ri "s/APP_DEBUG=true/APP_DEBUG=false/g" .env\n- sed -ri "s/http:\\/\\//https:\\/\\//g" .env\n- composer install --optimize-autoloader\n- npm run build\n')),(0,i.kt)("p",null,"This switches Laravel to production mode."))),(0,i.kt)("hr",null),(0,i.kt)("p",null,"Let's extract those recipes meaning individually."),(0,i.kt)("h2",{id:"nginx-setup"},"NGINX Setup"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"/docs/features/nginx"},"NGINX")," can be configured to serve PHP files. PHP files are served by the PHP-FPM server. This works by writing ",(0,i.kt)("inlineCode",{parentName:"p"},"fastcgi_pass")," directive in the NGINX configuration, which points to underlying PHP-FPM server proxy for given host."),(0,i.kt)("p",null,"The minimum configuration to enable PHP is:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"nginx:\n  fastcgi: on\n")),(0,i.kt)("h3",{id:"fastcgi-options"},(0,i.kt)("inlineCode",{parentName:"h3"},"fastcgi")," Options"),(0,i.kt)("p",null,"The ",(0,i.kt)("a",{parentName:"p",href:"/docs/features/runner#fastcgi"},(0,i.kt)("inlineCode",{parentName:"a"},"fastcgi"))," option has three options: ",(0,i.kt)("inlineCode",{parentName:"p"},"on"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"off"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"always"),". The difference between three options:"),(0,i.kt)("h4",{id:"fastcgi-options-off"},(0,i.kt)("inlineCode",{parentName:"h4"},"fastcgi")," Options ",(0,i.kt)("inlineCode",{parentName:"h4"},"off")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"location ~ \\.php$ {\n    return 404;\n    fastcgi_pass ....;\n}\n")),(0,i.kt)("p",null,"This essentially disables PHP support in NGINX because it directly return 404 without being forwarded to ",(0,i.kt)("inlineCode",{parentName:"p"},"fastcgi"),". This is the default value for ",(0,i.kt)("inlineCode",{parentName:"p"},"fastcgi"),"."),(0,i.kt)("h4",{id:"fastcgi-options-on"},(0,i.kt)("inlineCode",{parentName:"h4"},"fastcgi")," Options ",(0,i.kt)("inlineCode",{parentName:"h4"},"on")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"location ~ \\.php$ {\n    try_files $uri =404;\n    fastcgi_pass ......;\n}\n")),(0,i.kt)("p",null,"This detects all URLs that ends with ",(0,i.kt)("inlineCode",{parentName:"p"},".php")," and forwards it to the PHP-FPM server. However, if the file is not found, it will return 404 without being forwarded to ",(0,i.kt)("inlineCode",{parentName:"p"},"fastcgi"),"."),(0,i.kt)("h4",{id:"fastcgi-options-always"},(0,i.kt)("inlineCode",{parentName:"h4"},"fastcgi")," Options ",(0,i.kt)("inlineCode",{parentName:"h4"},"always")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"location ~ \\.php(/|$) {\n    fastcgi_pass ......;\n}\n")),(0,i.kt)("p",null,"This detects all URLs that ends with ",(0,i.kt)("inlineCode",{parentName:"p"},".php")," or contains ",(0,i.kt)("inlineCode",{parentName:"p"},".php")," in the path and forwards it to the PHP-FPM server. The path after ",(0,i.kt)("inlineCode",{parentName:"p"},".php")," is sent as additional path in ",(0,i.kt)("a",{parentName:"p",href:"https://www.php.net/manual/en/reserved.variables.server.php#:~:text=the%20authentication%20type.-,%27PATH_INFO%27,-Contains%20any%20client"},"$_SERVER","[","'PATH_INFO'","]"),"."),(0,i.kt)("h3",{id:"multiple-directory-setup"},"Multiple Directory Setup"),(0,i.kt)("p",null,"If you have multiple directory setup, it's important to write ",(0,i.kt)("inlineCode",{parentName:"p"},"fastcgi: on"),"\nwhere the directory should also serve PHP files, for example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"nginx:\n  fastcgi: on\n  locations:\n  - match: /admin/\n    root: public_app/public\n    fastcgi: on\n")),(0,i.kt)("p",null,"The second ",(0,i.kt)("inlineCode",{parentName:"p"},"fastcgi: on")," will make sure PHP files inside ",(0,i.kt)("inlineCode",{parentName:"p"},"/admin/")," directory are also served by PHP-FPM."),(0,i.kt)("h3",{id:"rewrite-root-directory"},"Rewrite root directory"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"nginx:\n  root: public_html/public\n")),(0,i.kt)("p",null,"The default root directory is ",(0,i.kt)("inlineCode",{parentName:"p"},"public_html"),", where app files are extracted from recipes.\nSome modern frameworks like Laravel and CodeIgniter put static files inside ",(0,i.kt)("inlineCode",{parentName:"p"},"public")," folder to avoid leaking bare ",(0,i.kt)("inlineCode",{parentName:"p"},"*.php")," files be accessed maliciously and creates RCE attack."),(0,i.kt)("p",null,"So when your app requires this behavior, you need to change the root folder to ",(0,i.kt)("inlineCode",{parentName:"p"},"public_html/public"),"."),(0,i.kt)("admonition",{type:"info"},(0,i.kt)("p",{parentName:"admonition"},"Not to be confused with ",(0,i.kt)("inlineCode",{parentName:"p"},"root:")," inside ",(0,i.kt)("inlineCode",{parentName:"p"},"nginx:"),", this setting is placed outside of ",(0,i.kt)("inlineCode",{parentName:"p"},"nginx:"),"\nbecause it will also tell Virtualmin to use this folder as e.g. SSL verification requests.")),(0,i.kt)("h3",{id:"reroute-indexphp"},"Reroute index.php"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"nginx:\n  locations:\n  - match: /\n    try_files: $uri $uri/ /index.php$is_args$args\n  fastcgi: on\n")),(0,i.kt)("p",null,"If you use frameworks, they also likes to handle custom routes. The ",(0,i.kt)("inlineCode",{parentName:"p"},"try_files:")," configuration\nhere is to instruct NGINX to try to serve the root ",(0,i.kt)("inlineCode",{parentName:"p"},"/index.php")," file in case no static files found\nin the given request URL."),(0,i.kt)("h3",{id:"multiple-website-in-a-domain"},"Multiple website in a domain"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"root: public_html\nnginx:\n  locations:\n  - match: ~ ^/(app|auth|api|web)/\n    root: public_app/public\n    fastcgi: on\n    try_files: $uri $uri/ /index.php$is_args$args\n  - match: /uploads/\n    alias: public_app/storage/app/public/\n  - match: /\n    try_files: $uri $uri/ /index.php$is_args$args\n  fastcgi: on\n")),(0,i.kt)("p",null,"The example setup above is a typical setup for combining a WordPress (the landing page) in ",(0,i.kt)("inlineCode",{parentName:"p"},"~/public_html"),"\nand a Laravel app in ",(0,i.kt)("inlineCode",{parentName:"p"},"~/public_app"),". Let's see what happens when we do requests from browser:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"/"),": Resolves to ",(0,i.kt)("inlineCode",{parentName:"li"},"/public_html/index.php")," and loads the landing page at ",(0,i.kt)("inlineCode",{parentName:"li"},"/"),"."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"/about"),": Resolves to ",(0,i.kt)("inlineCode",{parentName:"li"},"/public_html/index.php")," and loads the landing page at ",(0,i.kt)("inlineCode",{parentName:"li"},"/about"),"."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"/api/oauth"),": Resolves to ",(0,i.kt)("inlineCode",{parentName:"li"},"/public_app/index.php")," and loads the Laravel app at ",(0,i.kt)("inlineCode",{parentName:"li"},"/api/oauth"),"."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"/web/login"),": Resolves to ",(0,i.kt)("inlineCode",{parentName:"li"},"/public_app/index.php")," and loads the Laravel app at ",(0,i.kt)("inlineCode",{parentName:"li"},"/web/login"),"."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"/uploads/image.png"),": Resolves to ",(0,i.kt)("inlineCode",{parentName:"li"},"/public_app/storage/app/public/image.png")," and loads the image (if exist).")),(0,i.kt)("p",null,"Let's see another approach to combine multiple websites in a domain."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'root: public_html\nnginx:\n  locations:\n  - match: /app/\n    alias: public_app/public\n    fastcgi: on\n    try_files: $uri $uri/ @app\n  - match: "@app"\n    /app/(.*)$ /app/index.php last\n  - match: /uploads/\n    alias: public_app/storage/app/public/\n  - match: /\n    try_files: $uri $uri/ /index.php$is_args$args\n  fastcgi: on\n')),(0,i.kt)("p",null,"The example above puts the whole laravel app inside ",(0,i.kt)("inlineCode",{parentName:"p"},"/app/")," subfolder. Let's see how it works:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"/"),": Resolves to ",(0,i.kt)("inlineCode",{parentName:"li"},"/public_html/index.php")," and loads the landing page at ",(0,i.kt)("inlineCode",{parentName:"li"},"/"),"."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"/about"),": Resolves to ",(0,i.kt)("inlineCode",{parentName:"li"},"/public_html/index.php")," and loads the landing page at ",(0,i.kt)("inlineCode",{parentName:"li"},"/about"),"."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"/app/api/oauth"),": Resolves to ",(0,i.kt)("inlineCode",{parentName:"li"},"/public_app/index.php")," and loads the Laravel app at ",(0,i.kt)("inlineCode",{parentName:"li"},"/api/oauth"),"."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"/app/web/login"),": Resolves to ",(0,i.kt)("inlineCode",{parentName:"li"},"/public_app/index.php")," and loads the Laravel app at ",(0,i.kt)("inlineCode",{parentName:"li"},"/web/login"),"."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"/web/login"),": Resolves to ",(0,i.kt)("inlineCode",{parentName:"li"},"/public_html/index.php")," and loads the landing page at ",(0,i.kt)("inlineCode",{parentName:"li"},"/web/login")," (404 error)."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"/uploads/image.png"),": Resolves to ",(0,i.kt)("inlineCode",{parentName:"li"},"/public_app/storage/app/public/image.png")," and loads the image (if exist).")),(0,i.kt)("p",null,"You can read more about putting Laravel in subfolder using NGINX in this ",(0,i.kt)("a",{parentName:"p",href:"https://stackoverflow.com/a/62965174/3908409"},"StackOverflow answer"),"."),(0,i.kt)("h2",{id:"php-environment-setup"},"PHP environment setup"),(0,i.kt)("p",null,"The default PHP version is ",(0,i.kt)("inlineCode",{parentName:"p"},"7.4"),", which is the default provided from the OS."),(0,i.kt)("p",null,"To change PHP version used in PHP-FPM to the latest one, put this in runner:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"features:\n- php latest\n")),(0,i.kt)("p",null,"You can also use a fixed PHP version: ",(0,i.kt)("inlineCode",{parentName:"p"},"php 7.4"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"php 8.0"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"php 8.1"),"."),(0,i.kt)("p",null,"Unfortunately you can't use custom PHP version other than provided because it's tied to system daemon.\nWe always update the list to the latest supported version or latest major version starting from PHP 7.4."),(0,i.kt)("p",null,"Support for PHP extensions is varies but you can request a ticket to be included, provided the extension is provided officially by PHP."),(0,i.kt)("p",null,"When PHP version is changed, it's also changing the ",(0,i.kt)("inlineCode",{parentName:"p"},"php")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"composer")," version it used."),(0,i.kt)("p",null,"Alternatively, you can call the alternative ",(0,i.kt)("inlineCode",{parentName:"p"},"php")," version using ",(0,i.kt)("inlineCode",{parentName:"p"},"php81"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"php80"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"php56"),", etc."),(0,i.kt)("p",null,"You can also do this for composer, e.g. ",(0,i.kt)("inlineCode",{parentName:"p"},"php81 `which composer` install"),"."),(0,i.kt)("h2",{id:"composer-install"},"Composer install"),(0,i.kt)("p",null,"Composer is installed automatically. The good recommendation to install packages is with:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"composer install --no-dev --no-progress --optimize-autoloader\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"--no-dev")," to skip development packages (things like PHPUnit), to save space."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"--no-progress")," to skip the progress bar, because it's problematic when used inside runner."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"--optimize-autoloader")," to speed up the package resolution in production.")),(0,i.kt)("h3",{id:"clearing-composer-cache"},"Clearing composer cache"),(0,i.kt)("p",null,"If your development is stable enough, you can clear the cache to save space by calling:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"composer clear-cache\n")),(0,i.kt)("p",null,"The composer cache locates in ",(0,i.kt)("inlineCode",{parentName:"p"},"~/.composer/cache/"),"."),(0,i.kt)("h2",{id:"php-ini-configuration"},"PHP INI configuration"),(0,i.kt)("p",null,"The PHP INI configuration is useful to tweak the PHP behavior such at upload size limits.\nWhile you can't directly change the PHP INI located in system files, you can create ",(0,i.kt)("inlineCode",{parentName:"p"},".user.ini"),"\ninto PHP root folder (typically ",(0,i.kt)("inlineCode",{parentName:"p"},"~/public_html/.user.ini"),") and tweak the config there."),(0,i.kt)("p",null,"An example of PHP INI configuration is:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ini",metastring:'title="~/public_html/.user.ini"',title:'"~/public_html/.user.ini"'},"upload_max_filesize = 32M\npost_max_size = 32M\n")),(0,i.kt)("p",null,"See the list of available PHP INI configuration ",(0,i.kt)("a",{parentName:"p",href:"https://www.php.net/manual/en/ini.list.php"},"in official PHP documentation"),".\nTo see default values or if your change has been in effect, use ",(0,i.kt)("inlineCode",{parentName:"p"},"phpinfo()"),"."),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"},"PHP INI doesn't work? You may need to wait until the PHP process is restarted, which typically about 5 minutes without traffic or after about 500 requests.\nNote that you can't change configs with ",(0,i.kt)("inlineCode",{parentName:"p"},"PHP_INI_SYSTEM")," level because it's only changeable in the main system INI files.")),(0,i.kt)("h2",{id:"php-error-logging"},"PHP Error Logging"),(0,i.kt)("p",null,"The error logs can be seen in ",(0,i.kt)("inlineCode",{parentName:"p"},"NGINX Error Logs")," in Virtualmin web UI.\nYou won't see error details in your website because we use production default settings."),(0,i.kt)("p",null,"If you want to see the error details in website (not recommended!), change this setting in ",(0,i.kt)("inlineCode",{parentName:"p"},".user.ini"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ini",metastring:'title="~/public_html/.user.ini"',title:'"~/public_html/.user.ini"'},"display_errors = On\ndisplay_startup_errors = On\n")),(0,i.kt)("h2",{id:"restarting-php"},"Restarting PHP"),(0,i.kt)("p",null,"PHP doesn't need restart. Changing PHP files instantly changes the running server code."),(0,i.kt)("p",null,"The PHP-FPM instance itself is running as ",(0,i.kt)("inlineCode",{parentName:"p"},"ondemand")," and goes inactive after 5 minutes of no traffic."))}m.isMDXComponent=!0}}]);